{% extends "base.html" %}
{% load static %}

{% block title %}NeonX | AI Career Counselor{% endblock %}

{% block extra_head %}
<style>
    .gradient-bg {
        background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 50%, var(--accent-teal) 100%);
        min-height: 100vh;
        padding-top: 100px; /* Added padding to push content down below navbar */
    }
    
    .glass-effect {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--border-color);
    }
    
    .message-bubble {
        animation: fadeInUp 0.3s ease-out;
        margin-bottom: 16px;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .typing-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-secondary);
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-indicator:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
    
    .edit-options {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        margin: 16px 0;
    }
    
    .edit-option-item {
        padding: 12px 16px;
        margin: 8px 0;
        background: var(--card-bg);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    
    .edit-option-item:hover {
        background: var(--secondary-bg);
        border-color: var(--accent-blue);
        transform: translateX(4px);
    }
    
    .premium-glow {
        box-shadow: 0 0 20px rgba(67, 97, 238, 0.3);
    }

    .chat-container {
        min-height: 400px;
        max-height: 60vh;
        overflow-y: auto;
        background: var(--secondary-bg);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .user-message {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        color: white;
        border-radius: 20px 20px 8px 20px;
        margin-left: 30%;
        max-width: 70%;
    }

    .bot-message {
        background: var(--card-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 20px 20px 20px 8px;
        margin-right: 30%;
        max-width: 70%;
    }

    /* Custom button styles to match base.html */
    .btn-custom-primary {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        color: #fff;
        font-weight: 600;
        padding: 14px 28px;
        border-radius: 50px !important; /* Changed to capsule shape */
        border: none;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .btn-custom-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
    }

    .btn-custom-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: #fff;
        font-weight: 600;
        padding: 14px 28px;
        border-radius: 50px !important; /* Changed to capsule shape */
        border: none;
        transition: var(--transition);
    }

    .btn-custom-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
    }

    .btn-custom-warning {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: #fff;
        font-weight: 600;
        padding: 12px 24px;
        border-radius: 50px !important; /* Changed to capsule shape */
        border: none;
        transition: var(--transition);
    }

    .btn-custom-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
    }

    .btn-pulse {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(67, 97, 238, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(67, 97, 238, 0);
        }
    }

    /* Improved input field styles */
    .input-capsule {
        border-radius: 16px !important;
        padding: 14px 20px !important;
        font-size: 16px;
        border: 2px solid var(--border-color) !important;
        background: var(--card-bg) !important;
        transition: all 0.3s ease;
        width: 100%;
    }

    .input-capsule:focus {
        border-color: var(--accent-blue) !important;
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1) !important;
        outline: none;
    }

    .input-group {
        display: flex;
        gap: 16px;
        align-items: center;
        width: 100%;
    }

    .input-wrapper {
        flex: 1;
        position: relative;
    }

    /* Improved button spacing */
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
    }

    .action-buttons .btn-custom-primary,
    .action-buttons .btn-custom-success {
        margin: 8px;
        padding: 16px 32px;
    }

    /* Conversation spacing improvements */
    .conversation-message {
        margin-bottom: 20px;
    }

    .message-content {
        padding: 16px 20px;
        line-height: 1.5;
        word-wrap: break-word;
    }

    /* Welcome message spacing */
    .welcome-section {
        padding: 40px 20px;
    }

    /* Results card styling */
    .result-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .result-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    /* Feature badges alignment */
    .feature-badges {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-top: 16px;
        margin-bottom: 32px;
    }

    .feature-badge {
        display: flex;
        align-items: center;
        background: var(--card-bg);
        padding: 8px 16px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    /* Start button spacing */
    .start-section {
        margin-top: 24px;
    }

    /* Responsive design */
    @media (max-width: 640px) {
        .input-group {
            flex-direction: column;
            gap: 12px;
        }
        
        .action-buttons {
            flex-direction: column;
            gap: 12px;
        }
        
        .action-buttons .btn-custom-primary,
        .action-buttons .btn-custom-success {
            width: 100%;
            max-width: 280px;
            margin: 4px auto;
        }

        .user-message {
            margin-left: 10%;
            max-width: 90%;
        }

        .bot-message {
            margin-right: 10%;
            max-width: 90%;
        }

        .chat-container {
            padding: 16px;
            border-radius: 16px;
        }

        .feature-badges {
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .gradient-bg {
            padding-top: 120px; /* More padding on mobile for navbar */
        }
    }

    /* Container spacing adjustments */
    .container {
        margin-top: 0; /* Remove any default margin */
    }
</style>
{% endblock %}

{% block content %}
<div class="gradient-bg">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Premium Header -->
        <div class="text-center mb-8">
            <div class="glass-effect rounded-2xl p-6 mb-4 premium-glow">
                <h1 class="text-4xl font-bold text-white mb-3">
                    <i class="bi bi-stars text-warning mr-3"></i>
                    NeonX Career Intelligence
                </h1>
                <p class="text-accent-teal text-lg">AI-Powered Career Discovery Platform</p>
            </div>
        </div>

        <!-- Feature Badges - Aligned with conversation box -->
        <div class="feature-badges">
            <div class="feature-badge">
                <i class="bi bi-shield-check mr-2 text-accent-teal"></i>
                <span class="text-text-primary text-sm">Secure & Private</span>
            </div>
            <div class="feature-badge">
                <i class="bi bi-cpu mr-2 text-accent-teal"></i>
                <span class="text-text-primary text-sm">AI-Powered Insights</span>
            </div>
            <div class="feature-badge">
                <i class="bi bi-graph-up mr-2 text-accent-teal"></i>
                <span class="text-text-primary text-sm">Data-Driven Results</span>
            </div>
        </div>

        <!-- Premium Chat Container -->
        <div class="glass-effect rounded-2xl p-6 mb-6 premium-glow">
            <!-- Conversation Area -->
            <div id="conversation-container" class="chat-container overflow-y-auto space-y-4">
                <!-- Welcome Message -->
                <div class="text-center welcome-section">
                    <i class="bi bi-robot text-4xl text-accent-teal mb-4"></i>
                    <h3 class="text-xl font-semibold text-text-primary mb-3">Welcome to Your Career Journey</h3>
                    <p class="text-text-secondary">Start your personalized assessment to discover career paths that match your unique personality and strengths.</p>
                </div>
            </div>

            <!-- Input Area -->
            <div id="input-area" class="hidden">
                <div class="input-group">
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="user-input" 
                            placeholder="Enter your rating (1-10) or type 'edit' to make changes..."
                            class="input-capsule"
                        >
                    </div>
                    <button 
                        id="edit-btn"
                        class="btn-custom-warning hidden"
                        title="Edit previous answers"
                    >
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button 
                        id="send-btn"
                        class="btn-custom-primary flex items-center whitespace-nowrap"
                    >
                        Send <i class="bi bi-send ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Start Button -->
            <div id="start-area" class="text-center start-section">
                <button 
                    id="start-btn"
                    class="btn-custom-primary btn-pulse text-lg px-8 py-4"
                >
                    <i class="bi bi-play-circle mr-3"></i> Begin Career Assessment
                </button>
                <p class="text-text-secondary mt-4 text-sm">
                    <i class="bi bi-clock mr-2"></i> Takes 3-5 minutes â€¢ <i class="bi bi-lock mr-2"></i> Your data is secure
                </p>
            </div>
        </div>

        <!-- Results Area - Initially hidden, shown only after test completion -->
        <div id="results-area" class="hidden glass-effect rounded-2xl p-6 premium-glow">
            <div class="text-center mb-8">
                <i class="bi bi-diagram-3 text-4xl text-success mb-4"></i>
                <h2 class="text-2xl font-bold text-text-primary mb-3">Your Career Matches</h2>
                <p class="text-text-secondary">Based on your unique profile, here are your top career recommendations</p>
            </div>
            <div id="predictions-list" class="space-y-6">
                <!-- Predictions will appear here -->
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button 
                    onclick="restartAssessment()"
                    class="btn-custom-primary"
                >
                    <i class="bi bi-arrow-repeat mr-2"></i> Start New Assessment
                </button>
                <button 
                    onclick="downloadResults()"
                    class="btn-custom-success"
                >
                    <i class="bi bi-download mr-2"></i> Download Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let currentField = '';
    let conversationStep = '';
    let isProcessing = false;
    let assessmentCompleted = false;

    // DOM Elements
    const startArea = document.getElementById('start-area');
    const inputArea = document.getElementById('input-area');
    const conversationContainer = document.getElementById('conversation-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const startBtn = document.getElementById('start-btn');
    const editBtn = document.getElementById('edit-btn');
    const resultsArea = document.getElementById('results-area');
    const predictionsList = document.getElementById('predictions-list');

    // Session Storage Management
    function saveResultsToStorage(predictions) {
        sessionStorage.setItem('careerPredictions', JSON.stringify(predictions));
        sessionStorage.setItem('assessmentCompleted', 'true');
        sessionStorage.setItem('assessmentTimestamp', Date.now().toString());
    }

    function loadResultsFromStorage() {
        const predictions = sessionStorage.getItem('careerPredictions');
        const completed = sessionStorage.getItem('assessmentCompleted');
        
        if (predictions && completed === 'true') {
            return JSON.parse(predictions);
        }
        return null;
    }

    function clearResultsFromStorage() {
        sessionStorage.removeItem('careerPredictions');
        sessionStorage.removeItem('assessmentCompleted');
        sessionStorage.removeItem('assessmentTimestamp');
    }

    function restoreResultsView(predictions) {
        // Hide start area and input area
        startArea.style.display = 'none';
        inputArea.style.display = 'none';
        
        // Show results
        showResults(predictions);
        
        // Update conversation to show completion message
        conversationContainer.innerHTML = `
            <div class="text-center py-6">
                <i class="bi bi-check-circle text-4xl text-success mb-4"></i>
                <h3 class="text-xl font-semibold text-text-primary mb-3">Assessment Complete</h3>
                <p class="text-text-secondary">Your career assessment has been completed. Here are your results:</p>
            </div>
        `;
    }

    // Check for saved results on page load
    document.addEventListener('DOMContentLoaded', function() {
        const savedPredictions = loadResultsFromStorage();
        if (savedPredictions) {
            restoreResultsView(savedPredictions);
        } else {
            // Initially hide input area and results area
            inputArea.style.display = 'none';
            resultsArea.style.display = 'none'; // Hide results initially
        }
    });

    // Start counseling session
    startBtn.addEventListener('click', startCounseling);
    sendBtn.addEventListener('click', processAnswer);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isProcessing) processAnswer();
    });
    editBtn.addEventListener('click', () => {
        userInput.value = 'edit';
        processAnswer();
    });

    async function startCounseling() {
        try {
            // Clear any previous session storage when starting new assessment
            clearResultsFromStorage();
            
            const response = await fetch('/start-counseling/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const data = await response.json();
            
            if (data.success) {
                // Show conversation interface
                startArea.style.display = 'none';
                inputArea.style.display = 'block';
                
                // Clear welcome message and add initial messages
                conversationContainer.innerHTML = '';
                addMessage('bot', data.message);
                addMessage('bot', data.next_question);
                
                currentField = data.field;
                conversationStep = data.conversation_step;
                assessmentCompleted = false;
                
                userInput.focus();
                updateUIState();
            }
        } catch (error) {
            console.error('Error starting counseling:', error);
            showError('Error starting counseling session. Please try again.');
        }
    }

    async function processAnswer() {
        if (isProcessing) return;
        
        const answer = userInput.value.trim();
        
        if (!answer) {
            showError('Please enter your response');
            return;
        }

        isProcessing = true;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner mr-2"></i>Sending';

        // Add user message to conversation
        addMessage('user', answer);
        userInput.value = '';

        try {
            const response = await fetch('/process-answer/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    answer: answer,
                    field: currentField
                })
            });

            const data = await response.json();
            
            if (data.success) {
                // Handle edit options display
                if (data.edit_options) {
                    displayEditOptions(data.edit_options, data.message, data.next_question);
                } else {
                    if (data.message) {
                        addMessage('bot', data.message);
                    }
                    
                    if (data.next_question) {
                        addMessage('bot', data.next_question);
                    }
                }
                
                currentField = data.field;
                conversationStep = data.conversation_step;
                
                updateUIState();
                
                if (data.completed) {
                    inputArea.style.display = 'none';
                    assessmentCompleted = true;
                    showResults(data.predictions);
                }
            } else {
                showError(data.error || 'An error occurred');
            }
        } catch (error) {
            console.error('Error processing answer:', error);
            showError('Error processing your answer. Please try again.');
        } finally {
            isProcessing = false;
            sendBtn.disabled = false;
            sendBtn.innerHTML = 'Send <i class="bi bi-send ml-2"></i>';
        }
    }

    function addMessage(type, message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex message-bubble conversation-message ${type === 'user' ? 'justify-end' : 'justify-start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `rounded-2xl message-content ${
            type === 'user' ? 'user-message' : 'bot-message'
        }`;
        
        // Add typing indicator for bot messages
        if (type === 'bot') {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex space-x-1 mb-3';
            typingDiv.innerHTML = `
                <div class="typing-indicator"></div>
                <div class="typing-indicator"></div>
                <div class="typing-indicator"></div>
            `;
            bubble.appendChild(typingDiv);
            
            // Simulate typing delay
            setTimeout(() => {
                typingDiv.remove();
                bubble.innerHTML = `<p class="text-sm leading-relaxed">${message}</p>`;
            }, 1000);
        } else {
            bubble.innerHTML = `<p class="text-sm leading-relaxed">${message}</p>`;
        }
        
        messageDiv.appendChild(bubble);
        conversationContainer.appendChild(messageDiv);
        conversationContainer.scrollTop = conversationContainer.scrollHeight;
    }

    function displayEditOptions(editOptions, message, nextQuestion) {
        addMessage('bot', message);
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'edit-options';
        
        const optionsHtml = editOptions.map((option, index) => {
            const description = getFieldDescription(option);
            return `
                <div class="edit-option-item" onclick="selectEditOption('${option}')">
                    <div class="flex justify-between items-center">
                        <div>
                            <strong class="text-accent-blue">${index + 1}.</strong>
                            <span class="ml-2 text-text-primary">${description}</span>
                        </div>
                        <i class="bi bi-chevron-right text-accent-blue"></i>
                    </div>
                </div>
            `;
        }).join('');
        
        optionsDiv.innerHTML = optionsHtml;
        conversationContainer.appendChild(optionsDiv);
        
        if (nextQuestion) {
            addMessage('bot', nextQuestion);
        }
        
        conversationContainer.scrollTop = conversationContainer.scrollHeight;
    }

    function getFieldDescription(field) {
        const descriptions = {
            'C_score': 'Organization & Attention to Detail',
            'O_score': 'Openness to New Experiences',
            'E_score': 'Outgoing & Social Nature',
            'A_score': 'Cooperation & Team Spirit',
            'N_score': 'Stress Management & Resilience',
            'Numerical_Aptitude': 'Comfort with Numbers & Math',
            'Verbal_Aptitude': 'Language & Communication Skills',
            'Abstract_Reasoning': 'Pattern Recognition Ability',
            'Logical_Reasoning': 'Logical Thinking Skills',
            'Spatial_Aptitude': 'Spatial Visualization',
            'Enjoy_Teamwork': 'Enjoyment of Team Collaboration',
            'Creative_Thinking': 'Creative Problem-Solving',
            'Attention_to_Detail': 'Focus on Details'
        };
        return descriptions[field] || field;
    }

    function selectEditOption(field) {
        userInput.value = field;
        processAnswer();
    }

    function updateUIState() {
        // Show/hide edit button based on context
        if (conversationStep === 'editing' || conversationStep === 'editing_field') {
            editBtn.classList.add('hidden');
            userInput.placeholder = "Type your selection or response...";
        } else if (conversationStep !== 'completed') {
            editBtn.classList.remove('hidden');
            userInput.placeholder = "Enter rating (1-10) or type 'edit' to make changes...";
        }
        
        // Update input type based on context
        if (conversationStep === 'editing_field') {
            userInput.type = 'number';
            userInput.min = '1';
            userInput.max = '10';
        } else {
            userInput.type = 'text';
            userInput.removeAttribute('min');
            userInput.removeAttribute('max');
        }
    }

    function showResults(predictions) {
        if (!predictions) {
            predictionsList.innerHTML = `
                <div class="text-center text-danger py-8">
                    <i class="bi bi-exclamation-triangle text-4xl mb-4"></i>
                    <p class="text-lg">Unable to generate predictions at this time.</p>
                    <p class="text-sm text-text-secondary mt-2">Please try again later or contact support.</p>
                </div>
            `;
        } else {
            // Save results to session storage
            saveResultsToStorage(predictions);
            
            predictionsList.innerHTML = predictions.map((pred, index) => {
                const colors = [
                    'bg-gradient-to-r from-purple-500 to-pink-500',
                    'bg-gradient-to-r from-blue-500 to-cyan-500', 
                    'bg-gradient-to-r from-green-500 to-emerald-500'
                ];
                const icons = ['bi bi-briefcase', 'bi bi-graph-up', 'bi bi-rocket'];
                
                // Create a slug-friendly version of the career name for the URL
                const careerSlug = pred.career.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
                
                return `
                    <div class="result-card">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-full ${colors[index]} flex items-center justify-center mr-4">
                                    <i class="${icons[index]} text-white text-lg"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-text-primary text-lg">${index + 1}. ${pred.career}</h3>
                                    <p class="text-text-secondary text-sm">High compatibility match</p>
                                </div>
                            </div>
                            <span class="${colors[index]} text-white px-4 py-2 rounded-full text-sm font-semibold">
                                ${pred.probability}% match
                            </span>
                        </div>
                        <div class="w-full bg-border-color rounded-full h-3 mb-2">
                            <div class="${colors[index]} h-3 rounded-full transition-all duration-1000 ease-out" 
                                 style="width: ${pred.probability}%"></div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button 
                                onclick="viewCareerDetails('${careerSlug}', '${pred.career}')"
                                class="btn-custom-primary text-sm px-4 py-2 flex items-center"
                            >
                                <i class="bi bi-eye mr-2"></i> View Details
                            </button>
                            <button 
                                onclick="exploreRelatedMajors('${pred.career}')"
                                class="btn-custom-warning text-sm px-4 py-2 flex items-center"
                            >
                                <i class="bi bi-book mr-2"></i> Related Majors
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Show results area only after test completion
        resultsArea.style.display = 'block';
        resultsArea.scrollIntoView({ behavior: 'smooth' });
    }

    // New function to navigate to career details
    function viewCareerDetails(careerSlug, careerName) {
        // Store the current career being viewed (optional)
        sessionStorage.setItem('currentCareerView', careerName);
        
        // Open in same tab - results will be preserved when user clicks back
        window.location.href = `/careers/${careerSlug}/`;
    }

    // New function to search for related majors
    function exploreRelatedMajors(careerName) {
        // Store current state before navigating
        sessionStorage.setItem('searchFromResults', 'true');
        // Navigate to career list with search for this career
        window.location.href = `/careers/search/?q=${encodeURIComponent(careerName)}`;
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fixed top-4 right-4 bg-danger text-white px-6 py-3 rounded-xl shadow-lg z-50';
        errorDiv.innerHTML = `
            <div class="flex items-center">
                <i class="bi bi-exclamation-triangle mr-3"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }

    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'fixed top-4 right-4 bg-success text-white px-6 py-3 rounded-xl shadow-lg z-50';
        successDiv.innerHTML = `
            <div class="flex items-center">
                <i class="bi bi-check-circle mr-3"></i>
                <span>${message}</span>
            </div>
        `;
        document.body.appendChild(successDiv);
        
        setTimeout(() => {
            successDiv.remove();
        }, 5000);
    }

    function restartAssessment() {
        // Clear session storage
        clearResultsFromStorage();
        
        // Hide results area and show start area
        resultsArea.style.display = 'none';
        startArea.style.display = 'block';
        inputArea.style.display = 'none';
        
        // Clear predictions list
        predictionsList.innerHTML = '';
        
        // Reset conversation
        conversationContainer.innerHTML = `
            <div class="text-center welcome-section">
                <i class="bi bi-robot text-4xl text-accent-teal mb-4"></i>
                <h3 class="text-xl font-semibold text-text-primary mb-3">Welcome to Your Career Journey</h3>
                <p class="text-text-secondary">Start your personalized assessment to discover career paths that match your unique personality and strengths.</p>
            </div>
        `;
        
        // Reset state
        currentField = '';
        conversationStep = '';
        isProcessing = false;
        assessmentCompleted = false;
        
        // Scroll back to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function downloadResults() {
        try {
            const predictions = getCurrentPredictions();
            
            // Show loading state
            const downloadBtn = document.querySelector('button[onclick="downloadResults()"]');
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="bi bi-arrow-repeat spinner mr-2"></i>Generating Report...';
            downloadBtn.disabled = true;

            const response = await fetch('/download-report/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    predictions: predictions
                })
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'neonx_career_report.pdf';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                showSuccess('Report downloaded successfully!');
            } else {
                const errorData = await response.json();
                showError(errorData.error || 'Failed to download report');
            }
        } catch (error) {
            console.error('Download error:', error);
            showError('Error downloading report. Please try again.');
        } finally {
            const downloadBtn = document.querySelector('button[onclick="downloadResults()"]');
            downloadBtn.innerHTML = '<i class="bi bi-download mr-2"></i> Download Report';
            downloadBtn.disabled = false;
        }
    }

    function getCurrentPredictions() {
        const predictionElements = document.querySelectorAll('#predictions-list > div');
        const predictions = [];
        
        predictionElements.forEach(element => {
            const careerElement = element.querySelector('h3');
            const probabilityElement = element.querySelector('span.bg-gradient-to-r');
            
            if (careerElement && probabilityElement) {
                const career = careerElement.textContent.replace(/^\d+\.\s/, '');
                const probability = parseInt(probabilityElement.textContent);
                
                predictions.push({
                    career: career,
                    probability: probability
                });
            }
        });
        
        return predictions;
    }

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add spinner animation for Bootstrap icons
    const style = document.createElement('style');
    style.textContent = `
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}
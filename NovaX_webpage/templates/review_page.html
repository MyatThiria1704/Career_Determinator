{% extends 'base.html' %}
{% load static %}

{% block title %}‚≠êÔ∏è App Reviews ‚≠êÔ∏è{% endblock %}

{% block extra_head %}
<style>
/* Custom review page overrides using your theme variables */
body {
  padding-top: 100px; /* Prevent navbar overlap */
}
.form-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 2rem;
  display: flex;
  flex-direction: column;
  justify-content: center;
  transition: var(--transition);
}

.form-control, textarea {
  background: rgba(255,255,255,0.08);
  border: 1px solid var(--border-color);
  color: var(--text-primary);
  border-radius: var(--border-radius);
}

textarea::placeholder, input::placeholder { color: var(--text-secondary); }

.btn-custom {
  background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
  border: none;
  color: #fff;
  border-radius: var(--border-radius);
  font-weight: 600;
  transition: var(--transition);
}
.btn-custom:hover { opacity: 0.9; transform: translateY(-2px); }

.star-btn, .rate-star {
  color: gold;
  font-size: 1.6rem;
  cursor: pointer;
  transition: transform 0.2s ease;
}
.star-btn.active, .rate-star.active { text-shadow: 0 0 8px gold; }
.star-btn:hover, .rate-star:hover { transform: scale(1.2); }

.review-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
  gap: 2.5rem;
}
.review-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  padding: 1.75rem;
  text-align: center;
  box-shadow: var(--shadow);
  transition: var(--transition);
  position: relative;
}
.review-card:hover { transform: translateY(-4px); }

.review-name { font-weight:600; margin-top:0.6rem; font-size:1.1rem; }
.review-role { font-size:0.9rem; color:var(--text-secondary); margin-bottom:0.6rem; }
.review-stars { color:gold; font-size:1.1rem; margin-bottom:0.5rem; }
.review-text { font-size:0.95rem; color:var(--text-secondary); }
.toggle-text { color:var(--accent-blue); cursor:pointer; display:inline-block; margin-top:0.4rem; }

#no-results { text-align:center; color:var(--text-secondary); margin-top:2rem; }

.chart-container { width:100%; height:220px; }

.fade-in { animation: fadeIn 0.6s ease both; }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

#resetBtn {
  margin-top: 2rem;
  animation: fadeIn 0.4s ease-in-out;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container fade-in">
  <div class="text-center mb-5">
    <h1 data-i18n="reviews.title">What Our Users Are Saying</h1>
    <p style="color:var(--text-secondary);" data-i18n="reviews.subtitle">Real feedback. Real experiences.</p>
  </div>

  <!-- Top Section -->
  <div class="row g-4 mb-5 align-items-stretch">
    <!-- Chart -->
    <div class="col-md-4 d-flex">
      <div class="form-card text-center flex-fill">
        <h5 data-i18n="reviews.overview">Review Overview</h5>
        <div class="chart-container"><canvas id="reviewChart"></canvas></div>
      </div>
    </div>

    <!-- Filter -->
    <div class="col-md-4 d-flex">
      <div class="form-card text-center flex-fill">
        <h5 data-i18n="reviews.filter">Filter by Rating</h5>
        <div class="d-flex justify-content-center flex-wrap gap-2 mt-2">
          {% for i in "54321" %}
          <button type="button" class="star-btn btn btn-outline-light px-3 py-1 rounded-pill" data-star="{{ i }}">
            {% for j in "12345" %}
              {% if forloop.counter <= i|add:"0" %}‚òÖ{% else %}‚òÜ{% endif %}
            {% endfor %}
          </button>
          {% endfor %}
        </div>
        <small style="color: var(--text-secondary);" data-i18n="reviews.filter_tip">Tap to filter reviews</small>
      </div>
    </div>

    <!-- Write Review -->
    <div class="col-md-4 d-flex">
      <div class="form-card flex-fill">
        <h5 data-i18n="reviews.write_review">Write a Review ‚úçÔ∏è</h5>
        <form id="reviewForm" method="POST" action="{% url 'add_review' %}">
          {% csrf_token %}
          <input type="hidden" name="rating" id="ratingInput" value="">
          <div class="mb-3 mt-3">
            <textarea name="text" class="form-control" placeholder="Share your thoughts..." rows="5" required data-i18n-placeholder="reviews.placeholder"></textarea>
          </div>
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
              <label data-i18n="reviews.your_rating">Your Rating:</label>
              {% for i in "12345" %}
              <span class="rate-star" data-star="{{ i }}">‚òÖ</span>
              {% endfor %}
            </div>
            {% if not request.user.is_authenticated %}
            <div class="alert alert-warning py-1 px-2 small mb-0">
              <a href="{% url 'login' %}?next={{ request.path }}" data-i18n="reviews.login_link">Log in</a> to post
            </div>
            {% endif %}
            <button type="submit" class="btn btn-custom px-4" {% if not request.user.is_authenticated %}disabled{% endif %} data-i18n="reviews.submit">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Reviews Grid -->
  <div class="review-grid" id="reviewList">
    {% for review in reviews %}
    <div class="review-card fade-in" data-rating="{{ review.rating }}">
      <div class="review-stars">{% for i in "12345" %}{% if forloop.counter <= review.rating %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</div>
      <div class="review-name">{{ review.name }}</div>
      <div class="review-role" data-i18n="reviews.role">App User</div>
      <div class="review-text" data-full="{{ review.text|escape }}">
        {{ review.text|truncatewords:12 }}{% if review.text|wordcount > 12 %}...{% endif %}
      </div>
      {% if review.text|wordcount > 12 %}
      <a class="toggle-text" href="javascript:void(0)" data-i18n="reviews.see_more">See More</a>
      {% endif %}
    </div>
    {% empty %}
    <p class="text-center text-secondary" data-i18n="reviews.none">No reviews yet. Be the first!</p>
    {% endfor %}
    <div class="text-center mt-4">
      <button id="resetBtn" class="btn btn-outline-light px-4 py-2" data-i18n="reviews.show_all">Show All Reviews</button>
    </div>
  </div>

  <div id="no-results" data-i18n="reviews.no_results">No reviews found for this rating üòï</div>
</div>

<script>
// ‚≠êÔ∏è Ratings and filtering
document.addEventListener('DOMContentLoaded', function () {
  const stars = document.querySelectorAll('.rate-star');
  const ratingInput = document.getElementById('ratingInput');
  const starButtons = document.querySelectorAll('.star-btn');
  const reviewList = document.getElementById('reviewList');
  const noResults = document.getElementById('no-results');
  const reviewChartCanvas = document.getElementById('reviewChart');

  if (stars.length && ratingInput) {
    stars.forEach(star => {
      star.addEventListener('click', () => {
        const rating = parseInt(star.dataset.star);
        ratingInput.value = rating;
        stars.forEach(s => {
          s.style.opacity = s.dataset.star <= rating ? '1' : '0.3';
        });
      });
    });
  }

  if (starButtons.length && reviewList) {
    starButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const rating = parseInt(btn.dataset.star);
        let visible = false;
        const cards = document.querySelectorAll('.review-card');
        cards.forEach(card => {
          const cardRating = parseInt(card.dataset.rating);
          if (cardRating === rating) {
            card.style.display = 'block';
            visible = true;
          } else {
            card.style.display = 'none';
          }
        });
        noResults.style.display = visible ? 'none' : 'block';
        starButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      });
    });
  }

  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('toggle-text')) {
      const div = e.target.previousElementSibling;
      const fullText = div.dataset.full;
      if (e.target.textContent === 'See More') {
        div.textContent = fullText;
        e.target.textContent = 'Show Less';
      } else {
        const words = fullText.split(' ');
        div.textContent = words.slice(0, 12).join(' ') + (words.length > 12 ? '...' : '');
        e.target.textContent = 'See More';
      }
    }
  });

  // Chart
  function getCountsFromDOM() {
    const counts = [0,0,0,0,0];
    document.querySelectorAll('.review-card').forEach(card => {
      const r = parseInt(card.dataset.rating);
      if (r>=1 && r<=5) counts[r-1]++;
    });
    return counts;
  }

  let reviewChart = null;

  function renderChart() {
    if (!reviewChartCanvas) return;
    const ctx = reviewChartCanvas.getContext('2d');
    const data = getCountsFromDOM();
    const chartData = {
      labels: ['1‚òÖ','2‚òÖ','3‚òÖ','4‚òÖ','5‚òÖ'],
      datasets: [{data, borderColor:'#4cc9f0', backgroundColor:'rgba(76,201,240,0.14)', tension:0.4, fill:true}]
    };
    const options = { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,precision:0}} };
    if (reviewChart) reviewChart.destroy();
    reviewChart = new Chart(ctx, {type:'line', data:chartData, options});
  }

  renderChart();
});

document.getElementById('resetBtn').addEventListener('click', () => {
  document.querySelectorAll('.review-card').forEach(card => card.style.display='block');
  document.getElementById('no-results').style.display='none';
  document.querySelectorAll('.star-btn').forEach(btn => btn.classList.remove('active'));
});

function updateContent(lang) {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[lang]?.[key]) el.textContent = translations[lang][key];
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (translations[lang]?.[key]) el.setAttribute('placeholder', translations[lang][key]);
  });
}

</script>
{% endblock %}
